const assert = require('assert');
const fs = require('fs');
const utf8 = require('utf8');
const { loadPolicy } = require('@open-policy-agent/opa-wasm');

let rulekeeperPolicy;
let accessControlPolicy;

before(async () => {
  const rulekeeperWasm = fs.readFileSync('wasm/rulekeeper.wasm');
  const accessControlWasm = fs.readFileSync('wasm/access_control.wasm');

  const policyDataContent = fs.readFileSync('../data/customData.json');
  const encodedFileContent = utf8.encode(policyDataContent.toString());
  const policyData = JSON.parse(encodedFileContent);

  rulekeeperPolicy = await loadPolicy(rulekeeperWasm);
  rulekeeperPolicy.setData(policyData);

  accessControlPolicy = await loadPolicy(accessControlWasm);
  accessControlPolicy.setData(policyData);
});

describe('Custom Test', () => {
  it('Test', () => {
    const result = rulekeeperPolicy.evaluate({
      principal: 'bob',
      operation: 'GET /user',
      data: ['auth.local.username', 'auth.local.lowerCaseUsername', 'auth.local.email', 'auth.local.hashed_password', 'auth.local.passwordHashMethod', 'auth.timestamps.created', 'auth.timestamps.loggedin', 'auth.timestamps.updated', 'auth.facebook', 'auth.google', 'auth.apple', 'achievements.ultimateGearSets.healer', 'achievements.ultimateGearSets.wizard', 'achievements.ultimateGearSets.rogue', 'achievements.ultimateGearSets.warrior', 'achievements.streak', 'achievements.challenges', 'achievements.perfect', 'achievements.quests', 'backer', 'contributor', 'purchased.ads', 'purchased.txnCount', 'purchased.skin', 'purchased.hair', 'purchased.shirt', 'purchased.background.violet', 'purchased.plan.consecutive.count', 'purchased.plan.consecutive.offset', 'purchased.plan.consecutive.gemCapExtra', 'purchased.plan.consecutive.trinkets', 'purchased.plan.quantity', 'purchased.plan.extraMonths', 'purchased.plan.gemsBought', 'purchased.plan.mysteryItems', 'flags.tour.intro', 'flags.tour.classes', 'flags.tour.stats', 'flags.tour.tavern', 'flags.tour.party', 'flags.tour.guilds', 'flags.tour.challenges', 'flags.tour.market', 'flags.tour.pets', 'flags.tour.mounts', 'flags.tour.hall', 'flags.tour.equipment', 'flags.tutorial.common.habits', 'flags.tutorial.common.dailies', 'flags.tutorial.common.todos', 'flags.tutorial.common.rewards', 'flags.tutorial.common.party', 'flags.tutorial.common.pets', 'flags.tutorial.common.gems', 'flags.tutorial.common.skills', 'flags.tutorial.common.classes', 'flags.tutorial.common.tavern', 'flags.tutorial.common.equipment', 'flags.tutorial.common.items', 'flags.tutorial.common.mounts', 'flags.tutorial.common.inbox', 'flags.tutorial.common.stats', 'flags.tutorial.ios.addTask', 'flags.tutorial.ios.editTask', 'flags.tutorial.ios.deleteTask', 'flags.tutorial.ios.filterTask', 'flags.tutorial.ios.groupPets', 'flags.tutorial.ios.inviteParty', 'flags.tutorial.ios.reorderTask', 'flags.customizationsNotification', 'flags.showTour', 'flags.dropsEnabled', 'flags.itemsEnabled', 'flags.lastNewStuffRead', 'flags.rewrite', 'flags.classSelected', 'flags.rebirthEnabled', 'flags.recaptureEmailsPhase', 'flags.weeklyRecapEmailsPhase', 'flags.communityGuidelinesAccepted', 'flags.cronCount', 'flags.welcomed', 'flags.armoireEnabled', 'flags.armoireOpened', 'flags.armoireEmpty', 'flags.cardReceived', 'flags.warnedLowHealth', 'flags.verifiedUsername', 'flags.levelDrops', 'flags.lastWeeklyRecap', 'history.exp', 'history.todos', 'items.gear.equipped.armor', 'items.gear.equipped.head', 'items.gear.equipped.shield', 'items.gear.costume.armor', 'items.gear.costume.head', 'items.gear.costume.shield', 'items.gear.owned.headAccessory_special_blackHeadband', 'items.gear.owned.headAccessory_special_blueHeadband', 'items.gear.owned.headAccessory_special_greenHeadband', 'items.gear.owned.headAccessory_special_pinkHeadband', 'items.gear.owned.headAccessory_special_redHeadband', 'items.gear.owned.headAccessory_special_whiteHeadband', 'items.gear.owned.headAccessory_special_yellowHeadband', 'items.gear.owned.eyewear_special_blackTopFrame', 'items.gear.owned.eyewear_special_blueTopFrame', 'items.gear.owned.eyewear_special_greenTopFrame', 'items.gear.owned.eyewear_special_pinkTopFrame', 'items.gear.owned.eyewear_special_redTopFrame', 'items.gear.owned.eyewear_special_whiteTopFrame', 'items.gear.owned.eyewear_special_yellowTopFrame', 'items.gear.owned.eyewear_special_blackHalfMoon', 'items.gear.owned.eyewear_special_blueHalfMoon', 'items.gear.owned.eyewear_special_greenHalfMoon', 'items.gear.owned.eyewear_special_pinkHalfMoon', 'items.gear.owned.eyewear_special_redHalfMoon', 'items.gear.owned.eyewear_special_whiteHalfMoon', 'items.gear.owned.eyewear_special_yellowHalfMoon', 'items.special.snowball', 'items.special.spookySparkles', 'items.special.shinySeed', 'items.special.seafoam', 'items.special.valentine', 'items.special.valentineReceived', 'items.special.nye', 'items.special.nyeReceived', 'items.special.greeting', 'items.special.greetingReceived', 'items.special.thankyou', 'items.special.thankyouReceived', 'items.special.birthday', 'items.special.birthdayReceived', 'items.special.congrats', 'items.special.congratsReceived', 'items.special.getwell', 'items.special.getwellReceived', 'items.special.goodluck', 'items.special.goodluckReceived', 'items.lastDrop.count', 'items.lastDrop.date', 'items.pets', 'items.eggs', 'items.hatchingPotions', 'items.food', 'items.mounts', 'items.quests.dustbunnies', 'invitations.guilds', 'invitations.party', 'invitations.parties', 'party.quest.progress.up', 'party.quest.progress.down', 'party.quest.progress.collectedItems', 'party.quest.progress.collect', 'party.quest.RSVPNeeded', 'party.order', 'party.orderAscending', 'preferences.hair.color', 'preferences.hair.base', 'preferences.hair.bangs', 'preferences.hair.beard', 'preferences.hair.mustache', 'preferences.hair.flower', 'preferences.emailNotifications.unsubscribeFromAll', 'preferences.emailNotifications.newPM', 'preferences.emailNotifications.kickedGroup', 'preferences.emailNotifications.wonChallenge', 'preferences.emailNotifications.giftedGems', 'preferences.emailNotifications.giftedSubscription', 'preferences.emailNotifications.invitedParty', 'preferences.emailNotifications.invitedGuild', 'preferences.emailNotifications.questStarted', 'preferences.emailNotifications.invitedQuest', 'preferences.emailNotifications.importantAnnouncements', 'preferences.emailNotifications.weeklyRecaps', 'preferences.emailNotifications.onboarding', 'preferences.emailNotifications.majorUpdates', 'preferences.emailNotifications.subscriptionReminders', 'preferences.pushNotifications.unsubscribeFromAll', 'preferences.pushNotifications.newPM', 'preferences.pushNotifications.wonChallenge', 'preferences.pushNotifications.giftedGems', 'preferences.pushNotifications.giftedSubscription', 'preferences.pushNotifications.invitedParty', 'preferences.pushNotifications.invitedGuild', 'preferences.pushNotifications.questStarted', 'preferences.pushNotifications.invitedQuest', 'preferences.pushNotifications.majorUpdates', 'preferences.pushNotifications.mentionParty', 'preferences.pushNotifications.mentionJoinedGuild', 'preferences.pushNotifications.mentionUnjoinedGuild', 'preferences.pushNotifications.partyActivity', 'preferences.suppressModals.levelUp', 'preferences.suppressModals.hatchPet', 'preferences.suppressModals.raisePet', 'preferences.suppressModals.streak', 'preferences.tasks.groupByChallenge', 'preferences.tasks.confirmScoreNotes', 'preferences.dayStart', 'preferences.size', 'preferences.hideHeader', 'preferences.skin', 'preferences.shirt', 'preferences.timezoneOffset', 'preferences.sound', 'preferences.chair', 'preferences.allocationMode', 'preferences.autoEquip', 'preferences.dateFormat', 'preferences.sleep', 'preferences.stickyHeader', 'preferences.disableClasses', 'preferences.newTaskEdit', 'preferences.dailyDueDefaultView', 'preferences.advancedCollapsed', 'preferences.toolbarCollapsed', 'preferences.reverseChatOrder', 'preferences.displayInviteToPartyWhenPartyIs1', 'preferences.improvementCategories', 'preferences.language', 'preferences.webhooks', 'preferences.background', 'profile.name', 'stats.buffs.str', 'stats.buffs.int', 'stats.buffs.per', 'stats.buffs.con', 'stats.buffs.stealth', 'stats.buffs.streaks', 'stats.buffs.snowball', 'stats.buffs.spookySparkles', 'stats.buffs.shinySeed', 'stats.buffs.seafoam', 'stats.training.int', 'stats.training.per', 'stats.training.str', 'stats.training.con', 'stats.hp', 'stats.mp', 'stats.exp', 'stats.gp', 'stats.lvl', 'stats.class', 'stats.points', 'stats.str', 'stats.con', 'stats.int', 'stats.per', 'inbox.newMessages', 'inbox.optOut', 'inbox.blocks', 'tasksOrder.habits', 'tasksOrder.dailys', 'tasksOrder.todos.0', 'tasksOrder.rewards', 'secret', '_v', 'balance', '_cronSignature', 'challenges', 'guilds', 'loginIncentives', 'invitesSent', 'pinnedItemsOrder', '_id', 'apiToken', 'lastCron', 'newMessages', 'notifications', 'tags.0.name', 'tags.0.id', 'tags.1.name', 'tags.1.id', 'tags.2.name', 'tags.2.id', 'tags.3.name', 'tags.3.id', 'tags.3.name', 'tags.3.id', 'tags.5.name', 'tags.5.id', 'tags.6.name', 'tags.6.id', 'extra', 'pushDevices', '_ABtests', 'webhooks', 'pinnedItems.0.type', 'pinnedItems.0.path', 'pinnedItems.1.type', 'pinnedItems.1.path', 'pinnedItems.2.type', 'pinnedItems.2.path', 'pinnedItems.3.type', 'pinnedItems.3.path', 'pinnedItems.3.type', 'pinnedItems.3.path', 'pinnedItems.5.type', 'pinnedItems.5.path', 'unpinnedItems', '__v'],
    });
    console.log(result);
    assert(result);
  });
});
